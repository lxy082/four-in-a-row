# Gravity 3D Connect-4（重力三维四子棋）

## 游戏规则
- 棋盘为 5×5×5 的三维立方体，坐标 (x, y, z)，其中 z=0 为最底层。
- 重力方向固定向 -z。
- 落子采用“柱子模式”：玩家每回合只选择一个底面柱子 (x, y)，棋子会自动落到该柱子最低空位。
- 操作方式：先点击柱子进行选择，再点击【落子】按钮确认，才会真正落子。
- 若该柱子 5 个高度已满，则该步非法，提示“该位置已满，请重新选择”，轮到同一玩家重新下。
- 棋子为三维球体。
- 任意方向连续 4 子即胜（包括 x、y、z 轴方向，平面内斜线，以及三维空间斜线）。
- 若棋盘 125 格全部填满且无人达成 4 连，则平局。
- 模式：PVP 或人机对战（支持 AI 先手/后手）。
- 计时模式：支持 OFF / 30s / 60s，每回合倒计时结束未确认落子即判负。

## 最快运行（无需 npm）
1. 运行脚本：`run_server.sh`（Mac/Linux）或 `run_server.bat`（Windows），或执行 `python server.py`。
2. 浏览器打开 <http://localhost:8000>。

> `dist/` 是已构建的静态产物，使用 CDN import map 加载依赖，因此需要联网访问。

## GitHub Pages（Deploy from branch）
1. 推送本仓库的 `gh-pages` 分支到 GitHub（该分支仅包含可静态托管文件）。
2. 在 GitHub 仓库中进入 **Settings → Pages**。
3. **Source** 选择 **Deploy from a branch**。
4. **Branch** 选择 `gh-pages`，目录选择 `/ (root)`。
5. 保存后等待部署完成，访问显示的 Pages URL 即可。

> 所有资源使用相对路径，确保 Pages 子路径（例如 `/repo-name/`）正常加载。

## AI 设计说明
AI 采用 Minimax + AlphaBeta + 迭代加深，并加入“人类感”策略：
1. **立即胜利**：存在一步直胜则马上下。
2. **立即防守**：若对手有一步直胜威胁，优先封堵。
3. **中心偏好**：越接近中心柱子得分越高。
4. **造威胁/避免送杀**：搜索中倾向制造下一回合双威胁，并避免给对手直接胜利。

### 评估函数核心思想
- 预计算所有“连续 4 格线段”。
- 对每条线段：
  - 若同时出现双方棋子 → 记 0 分（无潜力）。
  - 若只出现己方棋子 k 个 → 加分（k 越大加分越高）。
  - 若只出现对手棋子 k 个 → 减分（k 越大惩罚越高）。
- 额外叠加“中心权重”，越接近 (2,2,2) 得分越高。

### 难度差异
- **Easy**：仅进行浅层搜索并在评分最高的前 K 个中随机选择，思考时间 ≤ 80ms。
- **Medium**：迭代加深 + AlphaBeta，深度约 2~4，思考时间 ≤ 500ms。
- **Hard**：迭代加深 + AlphaBeta，深度约 4~6，思考时间 ≤ 1200ms，并强化走子排序。

### AI 超时与卡顿修复说明
- **原因**：此前 AI 搜索没有严格的“硬上限”，可能在深度递归中耗时过长，导致 UI 看起来卡住。
- **修复**：主线程在每回合为 AI 计算设置时间预算（与计时模式联动），AI 搜索在 worker 内部按 `deadline` 逐层迭代并在超过时间上限时立即返回当前最佳着法；即使在计时 OFF 模式下，也有 25s 的硬上限。
- **AI 不再走的根因**：此前 AI 触发依赖仅在回合切换时运行，但落子动画期间 `isAnimating` 为 true，导致 AI 请求被短路且不会在动画结束后重新触发。
- **修复**：改为在 `gameStatus/turn/isAnimating/aiThinking` 条件满足时立即触发 AI，并加入超时 fallback（中心优先合法步），确保每回合都会落子。

### 阵营颜色错乱修复说明
- **原因**：人机模式下没有明确的 `humanPlayer/aiPlayer/currentTurn` 单一真相源，导致 AI 使用了当前回合颜色或被覆盖的玩家颜色。
- **修复**：引入固定的阵营映射（`humanPlayer` 与 `aiPlayer`）并在每次开局统一初始化，所有落子必须满足 `player === currentTurn` 且 AI 落子必须使用 `aiPlayer`，并在开发时输出断言错误提示。
